# Migration Guide: v1.6.6 to v1.7.0

## Overview

- **Summary**: This version introduces semantic setup flags, extracts versioning logic to a dedicated script, and simplifies environment configuration for better developer experience.
- **Platform**: platform-lib
- **From Version**: 1.6.6
- **To Version**: 1.7.0
- **Date**: 2025-10-12

## Breaking Changes

1. **Setup script flag changes**

   - **Impact**: Both scaffolded projects and platforms using `--include-optional` flag
   - **Action Required**: Replace with semantic flags: `--dev`, `--ci`, or `--platform`

2. **Removed scripts/platform-install.sh**

   - **Impact**: Platforms only
   - **Action Required**: Use `just setup --platform` instead of `just platform-install`

## New Features

- **Semantic setup flags**: `--dev`, `--ci`, `--platform` for clearer dependency installation
- **Version management script**: New `scripts/upversion.sh` wraps semantic-release
- **Registry authentication**: New `just registry-login` command for local GCP authentication
- **Simplified .envrc**: Template-based scaffolding with placeholder replacement
- **New ADRs**: ADR-012 (Semantic Setup Flags), ADR-013 (Scripts Over Actions/Plugins)

## Migration Steps

### For Scaffolded Projects

Projects scaffolded from this platform (regular applications).

#### Automatic Migration

```bash
just upgrade
```

This will update `NV_PLATFORM_VERSION` in `.envrc` automatically.

#### Manual Steps

If you need to adopt the new features:

##### Step 1: Update CI Workflows (if customized)

If you customized `.github/workflows/*.yml`:

```bash
# Update ci.yml and release.yml
# Replace:
bash scripts/setup.sh --include-optional

# With:
bash scripts/setup.sh --ci
```

##### Step 2: Update Local Documentation (optional)

If your README or docs reference setup commands, update them:

```bash
# Old
just setup --include-optional

# New
just setup --dev
```

##### Step 3: Adopt New Commands (optional)

New optional commands available:

```bash
just upversion           # Preview next version locally
just registry-login      # Authenticate with GCP locally
```

##### Step 4: Update Platform Version

```bash
sed -i 's/NV_PLATFORM_VERSION=1.6.6/NV_PLATFORM_VERSION=1.7.0/' .envrc
```

##### Step 5: Verify

```bash
grep NV_PLATFORM_VERSION .envrc
# Should show: export NV_PLATFORM_VERSION=1.7.0

just build
just test
```

### For Forked/Scaffolded Platforms

If you scaffolded your own platform from an earlier version.

#### Step 1: Identify Changed Files

Core platform files that changed:

- `scripts/setup.sh` - Added semantic flags, removed `--include-optional`
- `scripts/upversion.sh` - **NEW** - Wraps semantic-release
- `scripts/registry-login.sh` - **NEW** - GCP authentication
- `justfile` - Added `upversion` and `registry-login` recipes, removed `platform-install`
- `.github/workflows/ci.yml` - Updated to use `--ci` flag
- `.github/workflows/release.yml` - Updated to use `just upversion` and `just registry-login`
- `.envrc.template` - **NEW** - Template for scaffolding
- `test/scaffold.bats` - Updated to test new .envrc template pattern
- `test/template-export.bats` - Updated to check for .envrc.template

#### Step 2: Update Core Scripts

**Update scripts/setup.sh:**

```bash
# Backup current file
cp scripts/setup.sh scripts/setup.sh.backup

# Download new version (replace ORG with your org)
curl -o scripts/setup.sh https://raw.githubusercontent.com/ORG/platform-lib/v1.7.0/scripts/setup.sh
chmod +x scripts/setup.sh

# Review changes
diff scripts/setup.sh.backup scripts/setup.sh
```

Key changes in setup.sh:
- Replaced `--include-optional` with `--dev`, `--ci`, `--platform` flags
- Consolidated bats-core installation (was in platform-install.sh)
- Uses pre-built just binaries on Linux for faster CI

**Add new scripts:**

```bash
# Download upversion.sh
curl -o scripts/upversion.sh https://raw.githubusercontent.com/ORG/platform-lib/v1.7.0/scripts/upversion.sh
chmod +x scripts/upversion.sh

# Download registry-login.sh
curl -o scripts/registry-login.sh https://raw.githubusercontent.com/ORG/platform-lib/v1.7.0/scripts/registry-login.sh
chmod +x scripts/registry-login.sh
```

**Delete obsolete files:**

```bash
rm -f scripts/platform-install.sh
```

#### Step 3: Update justfile

Add new recipes and remove old ones:

```just
# Add these recipes:

[group('util')]
upversion *ARGS: _load
    @bash scripts/upversion.sh {{ARGS}}

[group('util')]
registry-login *ARGS: _load
    @bash scripts/registry-login.sh {{ARGS}}

# Remove this recipe if present:
# platform-install: ...
```

Update the setup recipe comment:

```just
# Before:
# Install development dependencies (use --include-optional for all tools)

# After:
# Install development dependencies (use --dev, --ci, or --platform flags)
```

#### Step 4: Update CI Workflows

**Update .github/workflows/ci.yml:**

```yaml
# Before:
- name: Setup environment
  run: bash scripts/setup.sh --include-optional

# After:
- name: Setup environment
  run: bash scripts/setup.sh --ci
```

**Update .github/workflows/release.yml:**

```yaml
# Before:
- name: Setup environment
  run: ./scripts/setup.sh

# After:
- name: Setup environment
  run: ./scripts/setup.sh --ci

# Add this step before publish:
- name: Authenticate with registry
  if: steps.upversion.outputs.new_release_published == 'true'
  env:
    GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
    GCP_REGISTRY_PROJECT_ID: ${{ secrets.GCP_REGISTRY_PROJECT_ID }}
    GCP_REGISTRY_REGION: ${{ secrets.GCP_REGISTRY_REGION }}
    GCP_REGISTRY_NAME: ${{ secrets.GCP_REGISTRY_NAME }}
  run: just registry-login --ci
```

#### Step 5: Create .envrc.template (Optional)

If you want the new simplified .envrc scaffolding pattern:

```bash
# Create template
cat > .envrc.template <<'EOF'
export PROJECT=__PROJECT_NAME__
export VERSION=__VERSION__

# Registry Configuration
export GCP_REGISTRY_PROJECT_ID=your-project-id
export GCP_REGISTRY_REGION=us-central1
export GCP_REGISTRY_NAME=your-repository-name
EOF
```

Then update `scripts/scaffold.sh` to use the template (see platform-lib v1.7.0 for full implementation).

#### Step 6: Update Tests

Update test files to work with new patterns:

```bash
# Update scaffold.bats to test new .envrc template
# Update template-export.bats to check for .envrc.template
# See platform-lib v1.7.0 test/ directory for reference
```

#### Step 7: Update Platform Documentation

Update these docs to reference new flags and commands:

**README.md:**
- Replace `just setup --include-optional` → `just setup --dev`
- Replace `just platform-install` → `just setup --platform`

**docs/user-guide.md:**
- Update setup section with new flags
- Add versioning customization section (optional)

**docs/architecture.md:**
- Document new setup.sh flags
- Document scripts/upversion.sh
- Document simplified .envrc pattern

#### Step 8: Update Platform Version

```bash
sed -i 's/export VERSION=1.6.6/export VERSION=1.7.0/' .envrc
```

#### Step 9: Test Platform

```bash
# Test setup with new flags
just setup --dev --platform

# Run platform tests
just platform-test
# Should show: 19/19 tests passing

# Test versioning (dry-run)
just upversion

# Test scaffolding
cd /tmp/test-project
mkdir test-app
bash ~/platform/scripts/scaffold.sh --src ~/platform --dest test-app --project myapp --non-interactive
cd test-app
just build
just test
```

## Rollback

### For Scaffolded Projects

```bash
# Restore platform version
sed -i 's/NV_PLATFORM_VERSION=1.7.0/NV_PLATFORM_VERSION=1.6.6/' .envrc
```

### For Platforms

```bash
# Restore backup files
cp scripts/setup.sh.backup scripts/setup.sh

# Remove new scripts
rm -f scripts/upversion.sh scripts/registry-login.sh

# Revert version
sed -i 's/export VERSION=1.7.0/export VERSION=1.6.6/' .envrc
```

## Troubleshooting

### Common Issues

**Issue**: `just platform-install` command not found

- **Solution**: Use `just setup --platform` instead

**Issue**: `just upversion` command not found

- **Solution**: Add the upversion recipe to your justfile (see Step 3)

**Issue**: CI fails with "Unknown option: --include-optional"

- **Solution**: Update workflows to use `--ci` flag (see Step 4)

**Issue**: Tests fail after migration

- **Solution**: Run `just setup --dev --platform` to reinstall dependencies with new flags

**Issue**: Registry authentication fails in CI

- **Solution**: Ensure you added the `registry-login` step to release.yml and secrets are configured

## Support

For questions or issues:

- Check the [platform documentation](../README.md)
- Review [architecture docs](../architecture.md)
- Review [ADR-012](../decisions/012-semantic-setup-flags.md)
- Review [ADR-013](../decisions/013-scripts-over-actions-plugins.md)
- Open an issue on GitHub

## Changelog

Full changelog: [CHANGELOG.md](../../CHANGELOG.md#170)
